<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TaskTracker â€” Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 20px; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
    .board { display:flex; gap:20px; flex-wrap:wrap; }
    .column { flex:1; min-width:280px; transition: background-color 0.2s ease; }
    .column.dragover { background-color: #e3f2fd; }
    .column h2 { text-align:center; background:#eee; padding:8px; border-radius:8px; }
    .list { min-height:80px; padding:10px; background:#fafafa; border-radius:10px; box-shadow:inset 0 0 3px rgba(0,0,0,0.1); }

    .task {
      background:#fff;
      margin:6px 0;
      padding:10px;
      border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
      display:flex;
      flex-direction:column;
      position:relative;
      cursor:pointer;
      transition: background-color 0.25s ease, transform 0.15s ease;
    }
    .task.dragging { opacity:0.6; }
    .task.selected { outline:2px solid #007bff; }
    .task.overdue { background-color: #ffb3b3 !important; }
    .task.due-soon { background-color: #ffe5b4 !important; }

    .task-header { display:flex; justify-content:space-between; align-items:center; }
    .task-date { font-size:12px; color:#555; margin-top:4px; }

    .menu-btn {
      background:none; border:none; font-size:18px; cursor:pointer; color:#555;
    }

    .task-menu {
      position:absolute; top:25px; right:10px;
      background:white; border:1px solid #ccc; border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      display:none; flex-direction:column; z-index:10;
    }
    .task-menu button {
      background:none; border:none; padding:6px 12px; text-align:left;
      cursor:pointer; font-size:14px;
    }
    .task-menu button:hover { background:#f0f0f0; }

    .task input[type="text"], .task input[type="date"] {
      margin-top:6px; padding:6px; border:1px solid #ccc; border-radius:5px; width:100%;
    }

    .save-btn {
      margin-top:8px; background:#28a745; color:white; border:none;
      border-radius:5px; padding:6px 10px; cursor:pointer;
    }
    .cancel-btn {
      margin-top:8px; background:#ccc; color:black; border:none;
      border-radius:5px; padding:6px 10px; cursor:pointer; margin-left:8px;
    }

    /* Search bar */
    .search-box {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #searchInput {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 240px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>TaskTracker</h1>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="ðŸ” Search tasks by title or date (e.g. 'oct', '2025-10-20', '10/20')" />
      <label><input type="checkbox" id="hideDoneChk" /> Hide Completed</label>
    </div>
    <div id="userSection"></div>
  </div>

  <div style="margin-bottom:12px;">
    <label>Add task:</label>
    <div class="row">
      <input type="text" id="newTitle" placeholder="Task title" />
      <input type="date" id="newDue" />
      <button class="btn" id="addBtn">Add</button>
    </div>
  </div>

  <div class="board">
    <div class="column" data-status="todo">
      <h2>To Do</h2>
      <div class="list" id="col-todo"></div>
    </div>
    <div class="column" data-status="in-progress">
      <h2>In Progress</h2>
      <div class="list" id="col-in-progress"></div>
    </div>
    <div class="column" data-status="done">
      <h2>Done</h2>
      <div class="list" id="col-done"></div>
    </div>
  </div>

<script>
const API_BASE = "/api";
const currentUser = localStorage.getItem("username");
let hideDone = false;
let searchQuery = "";

// small debounce util
function debounce(fn, wait=200){
  let t;
  return (...args)=>{ clearTimeout(t); t = setTimeout(()=> fn(...args), wait); };
}

// normalize a date string (YYYY-MM-DD) into several searchable forms
function normalizeDateVariants(isoDate) {
  if (!isoDate) return [];
  // isoDate expected in YYYY-MM-DD
  const parts = isoDate.split("-");
  if (parts.length !== 3) return [isoDate];
  const [yy, mm, dd] = parts;
  const d = new Date(isoDate);
  const monthNames = ["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"];
  const monthFull = ["january","february","march","april","may","june","july","august","september","october","november","december"];
  const mIdx = parseInt(mm,10)-1;
  const variants = [];
  // iso
  variants.push(isoDate);                 // 2025-10-20
  // dd-mm, mm-dd
  variants.push(`${dd}-${mm}`);           // 20-10
  variants.push(`${mm}-${dd}`);           // 10-20
  // dd-mm-yyyy and mm-dd-yyyy
  variants.push(`${dd}-${mm}-${yy}`);     // 20-10-2025
  variants.push(`${mm}-${dd}-${yy}`);     // 10-20-2025
  // slashes
  variants.push(`${mm}/${dd}/${yy}`);     // 10/20/2025
  variants.push(`${mm}/${dd}`);           // 10/20
  // month name
  if (mIdx >=0 && mIdx < monthNames.length) {
    variants.push(monthNames[mIdx]);      // oct
    variants.push(monthFull[mIdx]);       // october
    variants.push(`${monthNames[mIdx]} ${dd}`); // oct 20
    variants.push(`${monthFull[mIdx]} ${dd}`);  // october 20
  }
  // ensure lowercase
  return variants.map(s => s.toString().toLowerCase());
}

if (!currentUser) window.location.href = "auth.html";

function showUser() {
  const userSection = document.getElementById("userSection");
  userSection.innerHTML = `
    <span style="font-weight:bold;">ðŸ‘‹ ${currentUser}</span>
    <button id="logoutBtn" class="btn secondary" style="margin-left:10px;">Logout</button>`;
  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    localStorage.removeItem("username");
    window.location.href = "auth.html";
  });
}
showUser();

async function fetchTasks() {
  const res = await fetch(`${API_BASE}/tasks?username=${encodeURIComponent(currentUser)}`);
  const data = await res.json();
  return data.data || [];
}

function applyDueDateColor(el, task) {
  el.classList.remove("overdue", "due-soon");
  if (!task.due_date) return;
  const today = new Date();
  const due = new Date(task.due_date);
  // remove time portion by using UTC midnight diff approximation
  const diffDays = Math.floor((due - today) / (1000 * 60 * 60 * 24));
  if (diffDays < 0) el.classList.add("overdue");
  else if (diffDays <= 10) el.classList.add("due-soon");
}

function makeTaskElement(task) {
  const el = document.createElement("div");
  el.className = "task";
  el.draggable = true;
  el.dataset.id = task.id;

  const header = document.createElement("div");
  header.className = "task-header";

  const titleSpan = document.createElement("span");
  titleSpan.textContent = task.title;

  const menuBtn = document.createElement("button");
  menuBtn.className = "menu-btn";
  menuBtn.innerHTML = "â‹®";

  const menu = document.createElement("div");
  menu.className = "task-menu";

  const editOpt = document.createElement("button");
  editOpt.textContent = "âœï¸ Edit";
  editOpt.addEventListener("click", () => {
    menu.style.display = "none";
    startEditTask(el, task);
  });

  const delOpt = document.createElement("button");
  delOpt.textContent = "ðŸ—‘ Delete";
  delOpt.addEventListener("click", async () => {
    menu.style.display = "none";
    if (confirm("Delete this task?")) {
      await fetch(`${API_BASE}/tasks/${task.id}`, { method: "DELETE" });
      el.remove();
    }
  });

  menu.append(editOpt, delOpt);
  el.appendChild(menu);

  menuBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    menu.style.display = menu.style.display === "flex" ? "none" : "flex";
  });
  document.addEventListener("click", () => { menu.style.display = "none"; });

  header.appendChild(titleSpan);
  header.appendChild(menuBtn);
  el.appendChild(header);

  const due = document.createElement("div");
  due.className = "task-date";
  due.textContent = task.due_date ? `Due: ${task.due_date}` : "No due date";
  el.appendChild(due);

  applyDueDateColor(el, task);

  el.addEventListener("click", (e) => {
    if (e.target.classList.contains("menu-btn") || e.target.closest(".task-menu")) return;
    document.querySelectorAll(".task").forEach(t => t.classList.remove("selected"));
    el.classList.add("selected");
  });

  el.addEventListener("dragstart", e => {
    e.dataTransfer.setData("text/plain", task.id);
    el.classList.add("dragging");
  });
  el.addEventListener("dragend", () => el.classList.remove("dragging"));

  return el;
}

function startEditTask(el, task) {
  el.innerHTML = "";

  const inputTitle = document.createElement("input");
  inputTitle.type = "text";
  inputTitle.value = task.title;

  const inputDate = document.createElement("input");
  inputDate.type = "date";
  if (task.due_date) inputDate.value = task.due_date;

  const saveBtn = document.createElement("button");
  saveBtn.textContent = "Save";
  saveBtn.className = "save-btn";

  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "Cancel";
  cancelBtn.className = "cancel-btn";

  el.append(inputTitle, inputDate, saveBtn, cancelBtn);

  saveBtn.addEventListener("click", async () => {
    const newTitle = inputTitle.value.trim();
    const newDue = inputDate.value || null;
    await fetch(`${API_BASE}/tasks/${task.id}`, {
      method: "PUT",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ title: newTitle, due_date: newDue })
    });
    loadAndRender();
  });

  cancelBtn.addEventListener("click", () => loadAndRender());
}

async function loadAndRender() {
  const tasks = await fetchTasks();
  const cols = {
    todo: document.getElementById("col-todo"),
    "in-progress": document.getElementById("col-in-progress"),
    done: document.getElementById("col-done")
  };
  Object.values(cols).forEach(c => c.innerHTML = "");

  const q = (searchQuery || "").trim().toLowerCase();

  tasks.forEach(t => {
    if (hideDone && t.status === "done") return;

    // If there's a search query, attempt multiple match strategies
    if (q) {
      const titleMatch = (t.title || "").toLowerCase().includes(q);

      // Build a set of normalized date variants for matching
      const dateVariants = normalizeDateVariants(t.due_date || "");
      // also include the raw due_date as lower
      if (t.due_date) dateVariants.push((t.due_date || "").toLowerCase());

      // Try to match q in any of the date variants
      const dateMatch = dateVariants.some(v => v.includes(q));

      if (!titleMatch && !dateMatch) return; // no match => skip
    }

    const el = makeTaskElement(t);
    cols[t.status]?.appendChild(el);
  });
}

// === Drag-and-Drop logic ===
document.querySelectorAll(".column").forEach(column => {
  column.addEventListener("dragover", e => {
    e.preventDefault();
    column.classList.add("dragover");
  });
  column.addEventListener("dragleave", () => {
    column.classList.remove("dragover");
  });
  column.addEventListener("drop", async e => {
    e.preventDefault();
    column.classList.remove("dragover");
    const id = e.dataTransfer.getData("text/plain");
    const newStatus = column.dataset.status;
    await fetch(`${API_BASE}/tasks/${id}`, {
      method: "PUT",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ status: newStatus })
    });
    loadAndRender();
  });
});

// === Hide Completed Checkbox ===
document.getElementById("hideDoneChk").addEventListener("change", (e) => {
  hideDone = e.target.checked;
  loadAndRender();
});

// === Search Filter (debounced) ===
const onSearchInput = debounce((val) => {
  searchQuery = val.toLowerCase();
  loadAndRender();
}, 200);

const searchEl = document.getElementById("searchInput");
searchEl.addEventListener("input", (e) => onSearchInput(e.target.value || ""));

// allow pressing Enter to focus first result (optional UX)
searchEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    // small UX: focus first visible task
    const first = document.querySelector(".list .task");
    if (first) first.scrollIntoView({ behavior: "smooth", block: "center" });
  }
});

document.getElementById("addBtn").addEventListener("click", async () => {
  const title = document.getElementById("newTitle").value.trim();
  const due_date = document.getElementById("newDue").value || null;
  if (!title) return alert("Enter a title!");
  const res = await fetch(`${API_BASE}/tasks`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ title, due_date, status: "todo", username: currentUser })
  });
  if (res.ok) {
    document.getElementById("newTitle").value = "";
    document.getElementById("newDue").value = "";
    loadAndRender();
  } else {
    alert("Failed to add task");
  }
});

loadAndRender();
</script>
</body>
</html>
